<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Login / Registro / Pedidos (JWT)</title>

    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            margin: 0;
            height: 100vh;
            background: #1e88e5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: #fff;
            width: 360px;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background: #1565c0;
        }

        .link {
            text-align: center;
            margin-top: 10px;
            color: #1e88e5;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            margin-top: 15px;
            max-height: 150px;
            overflow: auto;
            font-size: 12px;
        }
        .avatar-upload {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            align-items: center;
            flex-direction: column;
        }

        .avatar-upload label {
            position: relative;
            width: 120px;
            height: 120px;
            cursor: pointer;
        }

        .avatar-upload img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #1e88e5;
            background: #f0f0f0;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #1e88e5;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #profileBox input {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        .endereco-box {
            margin-bottom: 12px;
        }

        .btn-localizacao {
            width: auto !important;
            padding: 6px 12px;
            font-size: 13px;
            background: #43a047;
            border-radius: 6px;
            margin-top: -5px;
        }
    </style>
</head>

<body>

<div class="card">
    <!-- LOGIN -->
    <div id="loginBox">
        <h2>Login</h2>
        <input id="loginEmail" type="email" placeholder="Email">
        <input id="loginPassword" type="password" placeholder="Senha">
        <button onclick="login(this)">Entrar</button>
        <div class="link" onclick="showRegister()">Criar uma conta</div>
    </div>

    <!-- ESCOLHA DO TIPO DE RESGITRO (Cliente ou Emnpresa)-->
    <div id="registerTypeBox" class="hidden">
        <h2>Tipo de Conta</h2>

        <button onclick="showRegisterCliente()">
            Criar conta Cliente
        </button>

        <button onclick="showRegisterEmpresa()">
            Criar conta Empresa
        </button>

        <div class="link" onclick="showLogin()">Voltar</div>
    </div>


    <!-- REGISTRO CLIENTE -->
    <div id="registerClienteBox" class="hidden">
        <h2>Registro</h2>
        <div class="avatar-upload">
            <label for="regFoto">
                <img
                    id="avatarPreview"
                    src="https://via.placeholder.com/120"
                    alt="Foto de perfil"
                >
                <span class="avatar-edit">+</span>
            </label>
            <input
                id="regFoto"
                type="file"
                accept="image/*"
                hidden
            >
        </div>

        <input id="regNome" placeholder="Nome completo">
        <input id="regEmail" type="email" placeholder="Email">
        <input id="regPassword" type="password" placeholder="Senha">
        <input id="regCpf"  placeholder="CPF">
        <div class="endereco-box">
            <input id="regEndereco" placeholder="Endereço">

            <button
                type="button"
                class="btn-localizacao"
                onclick="usarLocalizacao('cliente')"
            >
                Usar localização atual
            </button>
        </div>
        <input id="regTelefone"  placeholder="Telefone">
        <button onclick="registerCliente(this)">Registrar</button>
        <div class="link" onclick="showLogin()">Já tenho conta</div>
    </div>

    <!-- REGISTRO EMRPESA -->
    <div id="registerEmpresaBox" class="hidden">
        <h2>Registro Empresa</h2>

        <input id="empNome" placeholder="Nome do responsável">
        <input id="empCpf" placeholder="CPF">
        <input id="empTelefone" placeholder="Telefone">

        <input id="empEmail" placeholder="Email">
        <input id="empPassword" type="password" placeholder="Senha">

        <hr>

        <input id="empNomeFantasia" placeholder="Nome Fantasia">
        <input id="empCnpj" placeholder="CNPJ">

        <select id="empCategoria">
            <option value="">Selecione categoria</option>
            <option value="RESTAURANTE">Restaurante</option>
            <option value="FARMACIA">Farmácia</option>
            <option value="MERCADO">Mercado</option>
            <option value="FAST_FOOD">Fast Food</option>
            <option value="BARZINHO">Barzinho</option>
        </select>

        <div class="endereco-box">
            <input id="empEndereco" placeholder="Endereço da empresa">
            <button
                type="button"
                class="btn-localizacao"
                onclick="usarLocalizacao('empresa')"
            >
                Usar localização atual
            </button>
        </div>


        <label>Logo da empresa (obrigatório)</label>
        <input id="empLogo" type="file">

        <button onclick="registerEmpresa(this)">Cadastrar Empresa</button>

        <div class="link" onclick="showLogin()">Já tenho conta</div>

        <div id="empresaSection" class="hidden">
            <h3>Dados da Empresa</h3>
            <input id="empresaNomeFantasia">
            <select id="empresaCategoria"></select>
            <input id="empresaEndereco">
            <img id="empresaLogoImg">
        </div>

    </div>


    <!-- PEDIDOS -->
    <div id="orderBox" class="hidden">
        <h2>Pedidos</h2>
        <select id="estabelecimentoSelect" onchange="loadProdutos()"></select>
        <button onclick="loadProdutos()">Carregar Produtos</button>

        <select id="produtoSelect"></select>
        <input id="quantidadeInput" type="number" placeholder="Quantidade" value="1">
    
        <button onclick="createOrder()">Criar Pedido</button>
        <button onclick="listOrders()">Listar Pedidos</button>
        <button onclick="showProfile()">Configurações do Perfil</button>
        <input id="orderIdInput" placeholder="ID do pedido">
        <button onclick="getOrderById()">Buscar Pedido</button>
        <div class="link" onclick="logout()">Sair</div>

    </div>

    <!-- PERFIL -->
    <div id="profileBox" class="hidden">
        <h2>Meu Perfil</h2>

        <div class="avatar-upload">
            <img id="profileAvatar" src="https://via.placeholder.com/120">
        </div>

        <input id="profileNome" disabled>
        <input id="profileEmail" disabled>
        <input id="profileTelefone" disabled>
        <input id="profileEndereco" disabled>

        <button onclick="showOrders()">Voltar para Pedidos</button>
        <div class="link" onclick="logout()">Sair</div>
    </div>

    <pre id="output"></pre>
</div>

<script>

/*====== FUNCT q/ RETORNA HEADERS c/ TOKEN JWT p/ AUTENTICAÇÂO ======*/
function authHeaders() {
    const token = localStorage.getItem("token");
    return {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
    };
}

const empresaSection = document.getElementById("empresaSection");

const empresaNomeFantasia = document.getElementById("empresaNomeFantasia");
const empresaCategoria = document.getElementById("empresaCategoria");
const empresaEndereco = document.getElementById("empresaEndereco");
const empresaLogoImg = document.getElementById("empresaLogoImg");


/*====== URL e Logs ======*/
const API_URL = "http://localhost:5000";
const output = document.getElementById("output");

/*====== FUNCT p/ EXIBIR MSG ======*/
function log(msg) {
    output.textContent = msg;
    output.style.display = "block";
}

/*====== VALIDAÇÃO DE SENHA FORT no FRONT ======*/
function isStrongPassword(password) {
    return (
        password.length >= 6 &&
        /[A-Z]/.test(password) &&
        /[a-z]/.test(password) &&
        /\d/.test(password) &&
        /[^A-Za-z0-9]/.test(password)
    );
}


/* --------------------------------- TELAS --------------------------------- */
//Esconde todas as telas 
function hideAllScreens() {
    loginBox.classList.add("hidden");
    registerTypeBox.classList.add("hidden");
    registerClienteBox.classList.add("hidden");
    registerEmpresaBox.classList.add("hidden");
    orderBox.classList.add("hidden");
    profileBox.classList.add("hidden");
}


//Mostra Tela De Escolha do Tipo De Registro (Cliente ou Empresa) e Esconde Login
function showRegister() {
    hideAllScreens();
    registerTypeBox.classList.remove("hidden");
}

//Tela De Registro de Cleinte
function showRegisterCliente(){
    hideAllScreens();
    registerClienteBox.classList.remove("hidden");
}

//tela de registro de Empresa
function showRegisterEmpresa(){
    hideAllScreens();
    registerEmpresaBox.classList.remove("hidden");
}

//Mostra Tela De Login e Esconde Registro
function showLogin() {
    hideAllScreens();
    loginBox.classList.remove("hidden");
}

//Mostra Tela De Pedidos e Carega os estabelecimentos
function showOrders() {
    hideAllScreens();
    orderBox.classList.remove("hidden");
    loadEstabelecimentos();
}

//Faz o Logout
function logout() {
    localStorage.removeItem("token");
    showLogin();
    log("Logout realizado.");
}

//Mosrar a TELA do PERFIL do USUARIO LOGADO
function showProfile() {
    hideAllScreens();
    profileBox.classList.remove("hidden");
    loadProfile();
}


/*====== FUNCT DE RESGISTRO DE NOVO USUARIO (Tipo Cliente)======*/
async function registerCliente(btn) {
    if (//Verificação de campos obrigatórios
        !regNome.value ||
        !regEmail.value ||
        !regPassword.value ||
        !regCpf.value ||
        !regEndereco.value ||
        !regTelefone.value
    ) {
        log("Preencha todos os Campos Obrigatórios.");
        return;
    }

    if (!isStrongPassword(regPassword.value)) {//Verificação senha forte
        log(
            "Senha fraca: mínimo 6 caracteres, com letra maiúscula, " +
            "minúscula, número e caractere especial."
        );
        return;
    }   
    /*desabilita o botão enquanto aguarda a resposta da requisição e enquanto isso  a mensagem do botão é trocado por AGUARDE*/
    const originalText = btn.textContent;
    btn.textContent = "Aguarde..."; 
    btn.disabled = true;
    try {
        const formData = new FormData();

        formData.append("nome", regNome.value.trim());
        formData.append("email", regEmail.value.trim().toLowerCase());
        formData.append("password", regPassword.value);
        formData.append("cpf", regCpf.value.trim());
        formData.append("endereco", regEndereco.value.trim());
        formData.append("telefone", regTelefone.value.trim());

        //A foto do USUARIO/PESSOA não é Obrigatória
        if (regFoto.files.length > 0) {
            formData.append("foto", regFoto.files[0]);
        }

        const res = await fetch(`${API_URL}/auth/register/cliente`, {
            method: "POST",
            /*headers: authHeaders(),
            body: JSON.stringify({
                nome: regNome.value.trim(),
                email: regEmail.value.trim().toLowerCase(),
                password: regPassword.value,
                cpf: regCpf.value.trim(),
                endereco: regEndereco.value.trim(),
                telefone: regTelefone.value.trim()    
            })*/
            body : formData
        });

        const data = await res.json();
        if (!res.ok) {
            //msg de erro q vem lá do back
            log(data.error ?? "Erro ao realizar cadastro.");
            return;
        }    
        log("Cadastro realizado com sucesso!");

        /*Limpa tds os campos do formulario*/
        regNome.value = "";
        regEmail.value = "";
        regPassword.value = "";
        regCpf.value = "";
        regEndereco.value = "";
        regTelefone.value = "";
        regFoto.value = "";
    }catch (error){
        log("Erro de conexão com o servidor.");
        console.error(error);
    } finally {
        //habilita o botão novamente
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

/*====== FUNCT DE RESGISTRO DE NOVO USUARIO (Tipo Empresa)======*/
async function registerEmpresa(btn) {

    if (!empEmail.value || !empPassword.value || !empLogo.files[0]) {
        log("Preencha todos os campos obrigatórios.");
        return;
    }
    /*desabilita o botão enquanto aguarda a resposta da requisição e enquanto isso  a mensagem do botão é trocado por AGUARDE*/
    const originalText = btn.textContent;
    btn.textContent = "Aguarde..."; 
    btn.disabled = true;
    try{
        const formData = new FormData();

        formData.append("nome", empNome.value);
        formData.append("cpf", empCpf.value);
        formData.append("telefone", empTelefone.value);

        formData.append("email", empEmail.value);
        formData.append("password", empPassword.value);

        formData.append("nome_fantasia", empNomeFantasia.value);
        formData.append("cnpj", empCnpj.value);
        formData.append("categoria", empCategoria.value);
        formData.append("endereco_empresa", empEndereco.value.trim());

        formData.append("logo", empLogo.files[0]);

        const res = await fetch(`${API_URL}/auth/register/empresa`, {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        if (!res.ok) {
            log(data.error);
            return;
        }

        log("Empresa cadastrada com sucesso!");
        /*Limpa tds os campos do formulario*/

        empNome.value = "";
        empCpf.value = "";
        empTelefone.value = "";
        empEmail.value = "";
        empPassword.value = "";
        empNomeFantasia.value = "";
        empCnpj.value = "";
        empCategoria.value = "";
        empEndereco.value = "";
        empLogo.value = "";
        showLogin();
    } catch (error) {
        log("Erro de conexão com o servidor.");
        console.error(error);
    } finally {
        //habilita o botão novamente
        btn.textContent = originalText;
        btn.disabled = false;
    }
}



/*====== FUNCT DE LOGIN DO USUARIO ======*/
async function login(btn) {
    //verificação dos campos obrigatórios
    if (!loginEmail.value || !loginPassword.value) {
        log("Email e senha são obrigatórios.");
        return;
    }

    /*desabilita o botão enquanto aguarda a resposta da requisição e enquanto isso  a mensagem do botão é trocado por AGUARDE*/
    const originalText = btn.textContent;
    btn.textContent = "Aguarde...";    
    btn.disabled = true;

    try {
        const res = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({
                email: loginEmail.value.trim().toLowerCase(),
                password: loginPassword.value
            })
        });

        const data = await res.json();

        if (!res.ok) {
            log(data.error ?? "Email ou senha inválidos.");
            return;
        }

        localStorage.setItem("token", data.access_token);
        log("Login Realizado Com Sucesso")
        
        showOrders();//lista todos os pedidos

        /*Limpa tds os campos do formulario*/
        loginEmail.value = "";
        loginPassword.value = "";
    } catch (error) {
        log("Erro de conexão com o Servidor.");
        console.error(error);
    } finally {
        //habilita o botão novamente
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

/*====== FUNCTS DE CRIAR PEDIDOS ======*/
async function createOrder() {
    const token = localStorage.getItem("token");
    const estabelecimentoId = estabelecimentoSelect.value;
    const produtoOption = produtoSelect.selectedOptions[0];


    if (!produtoOption) {
        log("Selecione um produto antes de criar o pedido");
        return;
    }

    const produtoId = produtoOption.value;
    const preco = produtoOption.dataset.preco;
    const quantidade = quantidadeInput.value;

    const res = await fetch(`${API_URL}/orders/`, {
        method: "POST",
        headers: authHeaders(),
        body: JSON.stringify({
            estabelecimento_id: estabelecimentoId,
            items: [
                {
                    produto_id: produtoId,
                    quantidade: quantidade,
                    preco: preco
                }
            ]
        })
    });

    const text = await res.text();
    log(text);
}


/*====== FUNCTS DE LISTAR PEDIDOS ======*/
async function listOrders() {
    const token = localStorage.getItem("token");

    const res = await fetch(`${API_URL}/orders/`, {
        method: "GET",
        headers: authHeaders()
    });

    const data = await res.json();
    log(JSON.stringify(data, null, 2));
}

/*====== FUNCTS DE BUSCAR PEDIDO via ID ======*/
async function getOrderById() {
    const token = localStorage.getItem("token");
    const orderId = document.getElementById("orderIdInput").value;

    if (!orderId) {
        log("Informe o ID do pedido");
        return;
    }

    const res = await fetch(`${API_URL}/orders/${orderId}`, {
        method: "GET",
        headers: authHeaders()
    });

    const data = await res.json();
    log(JSON.stringify(data, null, 2));
}

/*====== FUNCTS DE CARREGAR OS ESTABELECIMENTOS ======*/
async function loadEstabelecimentos() {
    const res = await fetch(`${API_URL}/estabelecimentos`);
    const data = await res.json();

    estabelecimentoSelect.innerHTML = "";

    data.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.nome;
        estabelecimentoSelect.appendChild(opt);
    });
}

/*====== FUNCTS DE CARREGAR TDS OS PRODUTOS DE UM ESTABELECIMENTO ======*/
async function loadProdutos() {
    const estabelecimentoSelect = document.getElementById("estabelecimentoSelect");
    const estabelecimentoId = estabelecimentoSelect.value;

    if (!estabelecimentoId) {
        log("Selecione um estabelecimento primeiro");
        return;
    }

    const res = await fetch(
        `${API_URL}/estabelecimentos/${estabelecimentoId}/produtos`
    );

    const produtos = await res.json();
    produtoSelect.innerHTML = "";

    produtos.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.nome} - R$ ${p.preco}`;
        opt.dataset.preco = p.preco;
        produtoSelect.appendChild(opt);
    });

    if (produtoSelect.options.length > 0) {
        produtoSelect.selectedIndex = 0;
    }
}

const regFotoInput = document.getElementById("regFoto");
const avatarPreview = document.getElementById("avatarPreview");

regFotoInput.addEventListener("change", () => {
    const file = regFotoInput.files[0];

    if (!file) return;

    if (!file.type.startsWith("image/")) {
        log("Selecione apenas imagens.");
        regFotoInput.value = "";
        return;
    }

    const reader = new FileReader();
    reader.onload = () => {
        avatarPreview.src = reader.result;
    };
    reader.readAsDataURL(file);
});

async function loadProfile() {
    try {
        const res = await fetch(`${API_URL}/auth/me`, {
            headers: authHeaders()
        });

        const data = await res.json();

        if (!res.ok) {
            log(data.error || "Erro ao carregar perfil.");
            return;
        }

        // ====== Dados comuns que tanto cliente quanto empresa possuem ======
        profileNome.value = data.nome || "";
        profileEmail.value = data.email || "";
        profileTelefone.value = data.telefone || "";
        profileEndereco.value = data.endereco || "";
        console.log("Empresa", data.empresa.url_logo)
        if (data.url_logo) {
            profileAvatar.src = `${API_URL}${data.url_foto}`;
        } else {
            profileAvatar.src = "default-avatar.png";
        }

        // ====== Se for empresafaz o carregamento dos dados de empresa e mantem os dados padrão ======
        if (data.tipo_usuario === "empresa" && data.empresa) {

            console.log("Perfil Empresa:", data.empresa);

            //mostra a seção de empresa no front
            empresaSection.classList.remove("hidden");

            // Faz o preenchimenot de todos os campos da empresa
            empresaNomeFantasia.value = data.empresa.nome_fantasia || "";
            empresaCategoria.value = data.empresa.categoria || "";
            empresaEndereco.value = data.empresa.endereco_empresa || "";

            //carrega a logo da empresa
            if (data.empresa.url_logo) {
                empresaLogoImg.src = `${API_URL}${data.empresa.url_logo}`;
            } else {
                empresaLogoImg.src = "default-logo.png";
            }
        } else {
            //Se o USER for cliente então enconde a seção de empresa
            empresaSection.classList.add("hidden");
        }
    } catch (err) {
        console.error(err);
        log("Erro ao buscar dados do perfil.");
    }
}


async function usarLocalizacao(tipoUser) {
    if (!navigator.geolocation) {
        log("Geolocalização não é suportada neste navegador.");
        return;
    }

    log("Obtendo localização...");

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            try {
                const res = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
                );

                const data = await res.json();

                if (data && data.display_name) {
                    if (tipoUser === "cliente")
                        regEndereco.value = data.display_name;
                    if (tipoUser === "empresa")
                        empEndereco.value = data.display_name;
                        log("Endereço obtido com sucesso!");
                } else {
                    log("Não foi possível identificar o endereço.");
                }

            } catch (err) {
                console.error(err);
                log("Erro ao converter localização em endereço.");
            }
        },
        (error) => {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    log("Permissão de localização negada.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    log("Localização indisponível.");
                    break;
                case error.TIMEOUT:
                    log("Tempo esgotado ao obter localização.");
                    break;
                default:
                    log("Erro ao obter localização.");
            }
        }
    );
}

async function updateProfile() {

    const formData = new FormData();

    formData.append("nome", profileNome.value);
    formData.append("telefone", profileTelefone.value);
    formData.append("endereco", profileEndereco.value);

    if (newFoto.files[0]) {
        formData.append("foto", newFoto.files[0]);
    }

    const res = await fetch(`${API_URL}/auth/me`, {
        method: "PUT",
        headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`
        },
        body: formData
    });

    const data = await res.json();

    if (!res.ok) {
        log(data.error);
        return;
    }

    log("Perfil atualizado!");
}


// Qnd já está logado ou seja o token no localstorage, roda a funct de mostra pedidos
if (localStorage.getItem("token")) {
    showOrders();
}
</script>

</body>
</html>
